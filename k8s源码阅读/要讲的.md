# apiserver解读

[访问docker-desktop-for-mac安装的kubernetes的etcd](https://blog.csdn.net/yezi1993/article/details/106430390)



## 1.有什么功能

创建流程图

<img src="/Users/zhangjiazhen03/github/knowledge/k8s源码阅读/img/resize,w_2048,m_lfit.png" alt="img" style="zoom:50%;" />

Kubernetes Pod资源对象创建流程介绍如下。
（1）使用kubectl工具向Kubernetes API Server发起创建Pod资源对象的请求。
（2）Kubernetes API Server验证请求并将其持久保存到Etcd集群中。
（3）Kubernetes API Server基于Watch机制通知kube-scheduler调度器。
（4）kube-scheduler调度器根据预选和优选调度算法为Pod资源对象选择最优的节点并通知Kubernetes API Server。
（5）Kubernetes API Server将最优节点持久保存到Etcd集群中。
（6）Kubernetes API Server通知最优节点上的kubelet组件。
（7）kubelet组件在所在的节点上通过与容器进程交互创建容器。
（8）kubelet组件将容器状态上报至Kubernetes API Server。
（9）Kubernetes API Server将容器状态持久保存到Etcd集群中。

## 2.主要可分为哪些部分

kube-apiserver为丰富周边工具和库生态系统，提供了3种HTTP Server服务，用于将庞大的kube-apiserver组件功能进行解耦，这3种HTTP Server分别是APIExtensionsSerer、KubeAPIServer、AggregatorServer。不同服务的应用场景不同，提供的资源也不同，但它们都可以通过kubectl工具或接口进行资源

<img src="/Users/zhangjiazhen03/github/knowledge/k8s源码阅读/img/3.png" alt="img" style="zoom: 50%;" />

APIExtensionsServer扩展服务和AggregatorServer聚合服务都是可以在不修改Kubernetes核心代码的前提下扩展Kubernetes API的方式。只有KubeAPIServer核心服务是Kubernetes系统运行的基础。

<img src="https://qiankunli.github.io/public/upload/kubernetes/apiserver_overview.png" alt="img" style="zoom:50%;" />

## 3.初始化流程（重要）

在kube-apiserver组件启动过程中，代码逻辑可分为9个步骤，分别介绍如下。
（1）资源注册。
（2）Cobra命令行参数解析。
（3）创建APIServer通用配置。
（4）创建APIExtensionsServer。
（5）创建KubeAPIServer。
（6）创建AggregatorServer。
（7）创建GenericAPIServer。
（8）启动HTTP服务。
（9）启动HTTPS服务。

<img src="https://staticcdn1-5.umiwi.com/epms_ebook/d94ccd6b62695d5ae3d4b2343e52cc3d.jpg?x-oss-process=image/resize,w_2048,m_lfit" alt="img" style="zoom:50%;" />



#### 3.1 资源注册

kube-apiserver组件启动后的第一件事情是将Kubernetes所支持的资源注册到Scheme资源注册表中，这样后面启动的逻辑才能够从Scheme资源注册表中拿到资源信息并启动和运行APIExtensionsServer、KubeAPIServer、AggregatorServer这3种服务。
资源的注册过程并不是通过函数调用触发的，而是通过Go语言的导入（import）和初始化（init）机制触发的。

1. 初始化Scheme资源注册表
2. 注册Kubernetes所支持的资源



### 

## 4.资源概念（重要）



## 5.如何与etcd交互（重要）

<img src="/Users/zhangjiazhen03/github/knowledge/k8s源码阅读/img/15.png" alt="image-20220327173728388" style="zoom:50%;" />

### 通用存储接口

<img src="/Users/zhangjiazhen03/Library/Application Support/typora-user-images/image-20220327174918699.png" alt="image-20220327174918699" style="zoom:50%;" />

- ● Versioner：资源版本管理器，用于管理Etcd集群中的数据版本对象。
- ● Create：创建资源对象的方法。
- ● Delete：删除资源对象的方法。
- ● Watch：通过Watch机制监控资源对象变化方法，只应用于单个key。
- ● WatchList：通过Watch机制监控资源对象变化方法，应用于多个key（当前目录及目录下所有的key）。
- ● Get：获取资源对象的方法。
- ● GetToList：获取资源对象的方法，以列表（List）的形式返回。
- ● List：获取资源对象的方法，以列表（List）的形式返回。
- ● GuaranteedUpdate：保证传入的tryUpdate函数运行成功。
- ● Count：获取指定key下的条目数量。Storage.Interface是通用存储接口，实现通用存储接口的分别是CacherStorage资源存储对象和UnderlyingStorage资源存储对象，分别介绍如下。
- ● CacherStorage：带有缓存功能的资源存储对象，它定义在vendor/k8s.io/apiserver/pkg/storage/cacher/cacher.go中。
- ● UnderlyingStorage：底层存储对象，真正与Etcd集群交互的资源存储对象，它定义在vendor/k8s.io/apiserver/pkg/storage/etcd3/store.go中。

### CacherStorage缓存层

<img src="/Users/zhangjiazhen03/Library/Application Support/typora-user-images/image-20220327175446436.png" alt="image-20220327175446436" style="zoom: 25%;" />

上图是缓存的应用场景

<img src="/Users/zhangjiazhen03/Library/Application Support/typora-user-images/image-20220327180804151.png" alt="image-20220327180804151" style="zoom: 50%;" />



- ● cacheWatcher：Watcher观察者管理。
- ● watchCache：通过Reflector框架与UnderlyingStorage底层存储对象交互，UnderlyingStorage与Etcd集群进行交互，并将回调事件分别存储至w.onEvent、w.cache、cache.Store中。
- ● Cacher：用于分发给目前所有已连接的观察者，分发过程通过非阻塞（Non-Blocking）机制实现。





## 6.以创建pod为例（重要）